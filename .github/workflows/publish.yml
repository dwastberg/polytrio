  name: Build and Publish

  on:
    workflow_dispatch:
      inputs:
        publish_target:
          description: 'Publish target'
          required: true
          default: 'none'
          type: choice
          options:
            - none
            - testpypi
            - pypi

  permissions:
    contents: read

  jobs:
    test:
      name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
      runs-on: ${{ matrix.os }}
      strategy:
        fail-fast: true
        matrix:
          os: [ubuntu-latest, windows-latest, macos-latest]
          python-version: ["3.10", "3.11", "3.12", "3.13"]

      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v5
          with:
            python-version: ${{ matrix.python-version }}
        - uses: astral-sh/setup-uv@v4
        - name: Build package
          run: |
            uv pip install --system maturin
            maturin build --release
        - name: Install package
          shell: bash
          run: |
            uv pip install --system target/wheels/*.whl --force-reinstall --no-deps
        - name: Install test dependencies
          run: |
            uv pip install --system pytest numpy shapely
        - name: Run tests
          run: |
            uv run --no-project pytest tests/ -v

    build-wheels:
      name: Build wheels on ${{ matrix.platform.os }} - ${{ matrix.platform.target }}
      needs: test
      runs-on: ${{ matrix.platform.os }}
      strategy:
        fail-fast: true
        matrix:
          platform:
            - os: ubuntu-latest
              target: x86_64
              manylinux: manylinux_2_28
              container: manylinux_2_28

            - os: ubuntu-latest
              target: aarch64
              manylinux: manylinux_2_28
              container: manylinux_2_28

            - os: macos-13
              target: x86_64

            - os: macos-latest
              target: aarch64

            - os: windows-latest
              target: x86_64

      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v5
          with:
            python-version: "3.13"
        - uses: dtolnay/rust-toolchain@stable

        - name: Set up QEMU (for Linux ARM)
          if: matrix.platform.os == 'ubuntu-latest' && matrix.platform.target == 'aarch64'
          uses: docker/setup-qemu-action@v3
          with:
            platforms: arm64

        - name: Build wheels
          uses: PyO3/maturin-action@v1
          with:
            target: ${{ matrix.platform.target }}
            args: --release --out dist --find-interpreter
            manylinux: ${{ matrix.platform.manylinux }}
            container: ${{ matrix.platform.container }}
            sccache: 'true'

        - name: Upload wheels
          uses: actions/upload-artifact@v4
          with:
            name: wheels-${{ matrix.platform.os }}-${{ matrix.platform.target }}
            path: dist/*.whl
            if-no-files-found: error

    build-sdist:
      name: Build source distribution
      needs: test
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Build sdist
          uses: PyO3/maturin-action@v1
          with:
            command: sdist
            args: --out dist
        - uses: actions/upload-artifact@v4
          with:
            name: sdist
            path: dist/*.tar.gz
            if-no-files-found: error

    publish-testpypi:
      name: Publish to TestPyPI
      needs: [build-wheels, build-sdist]
      runs-on: ubuntu-latest
      if: github.event.inputs.publish_target == 'testpypi'
      environment:
        name: testpypi
        url: https://test.pypi.org/p/polytrio
      permissions:
        id-token: write
      steps:
        - uses: actions/download-artifact@v4
          with:
            path: dist/
            pattern: '*'
            merge-multiple: true
        - run: ls -lah dist/
        - uses: pypa/gh-action-pypi-publish@release/v1
          with:
            repository-url: https://test.pypi.org/legacy/

    publish-pypi:
      name: Publish to PyPI
      needs: [build-wheels, build-sdist]
      runs-on: ubuntu-latest
      if: github.event.inputs.publish_target == 'pypi'
      environment:
        name: pypi
        url: https://pypi.org/p/polytrio
      permissions:
        id-token: write
      steps:
        - uses: actions/download-artifact@v4
          with:
            path: dist/
            pattern: '*'
            merge-multiple: true
        - run: ls -lah dist/
        - uses: pypa/gh-action-pypi-publish@release/v1

